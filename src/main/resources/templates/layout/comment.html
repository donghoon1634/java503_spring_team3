<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
  <meta charset="UTF-8">
    <title>Title</title>
  <script>
    $(document).ready(function () {


      // 댓글추천
      usercommnetlike();
      // 댓글 등록순
      $("#ulCommentIdxAsc").on("click", function () {
        var ulIdx = $("#ulIdx").val();
        $.ajax({
          url: "/ulComment/asc/" + ulIdx,
          method: "GET",
          success: function (data) {
            // 서버에서 받은 댓글 목록 (data)은 JSON 배열이므로, 이를 HTML로 변환하여 표시
            let commentHtml = '';
            data.forEach(function (comment) {
              commentHtml += `
                        <div class="d-flex mb-3 comment ">
                            <div class="col-sm-1">
                                <img src="/img/프로필.jpg" style="width: 40px; height: 40px" alt="프로필">
                            </div>
                            <div class="ml-1 flex-grow-1">
                                <div >
                                    <p class="d-none commentIdx" name="commentIdx">${comment.ulCommentIdx}</p>
                                    <p>
                                        <strong>${comment.ulCommentNickname}</strong>
                                    </p>
                                    <p>
                                        <span>${comment.ulCommentLocation}</span>
                                        <span >${comment.ulCommentcreatedate}</span>
                                    </p>
                                    <p><strong>${comment.ulCommentContents}</strong></p>
                                    <div class="d-flex align-items-center">
                                        <img src="/img/good.png" style="width:22px; height: 22px;" alt="추천" class="ulCommentLike">
                                        <span>${comment.ulCommentLike}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
            `;
            });
            // 댓글 목록을 업데이트
            $("#commentsList").html(commentHtml);
            usercommnetlike();
            alert("등록순");
          },
          error: function (error) {
            console.error("Error: " + error);
            alert("오류");
          }
        });
      });
      // 댓글 추천순
      $("#ulCommentIdxDesc").on("click", function () {
        var ulIdx = $("#ulIdx").val(); // ulIdx 값 가져오기
        $.ajax({
          url: "/ulComment/desc/" + ulIdx, // URL 수정
          method: "GET",
          success: function (data) {
            // 서버에서 받은 댓글 목록 (data)은 JSON 배열이므로, 이를 HTML로 변환하여 표시
            let commentHtml = '';
            data.forEach(function (comment) {
              commentHtml += `
                        <div class="d-flex mb-3 comment ">
                            <div class="col-sm-1">
                                <img src="/img/프로필.jpg" style="width: 40px; height: 40px" alt="프로필">
                            </div>
                            <div class="ml-1 flex-grow-1">
                                <div >
                                    <p class="d-none commentIdx" name="commentIdx">${comment.ulCommentIdx}</p>
                                    <p>
                                        <strong>${comment.ulCommentNickname}</strong>
                                    </p>
                                    <p>
                                        <span>${comment.ulCommentLocation}</span>
                                        <span >${comment.ulCommentcreatedate}</span>
                                    </p>
                                    <p><strong>${comment.ulCommentContents}</strong></p>
                                    <div class="d-flex align-items-center">
                                        <img src="/img/good.png" style="width:22px; height: 22px;" alt="추천" class="ulCommentLike">
                                        <span>${comment.ulCommentLike}</span>
                                    </div>
                                </div>
                            </div>
                        </div>


            `;
            });
            // 댓글 목록을 업데이트
            $("#commentsList").html(commentHtml);
            usercommnetlike();
            alert("최신순");
          },
          error: function (error) {
            console.error("Error: " + error);
            alert("오류");
          }
        });

      });
      // 댓글 삭제
      $("#ulcommentDelete").on("click", function () {
        $("#ulcomment_method").val("DELETE");
        var ulcomfrm = $("#ulcomfrm")[0];
        ulcomfrm.action = "/board/comment/" + $("#ulIdx").val();
        ulcomfrm.submit();
      });
    });

    function usercommnetlike() {
      $(".ulCommentLike").on("click", function () {
        var ulCommentIdx = $(this).parent().parent().children("p.commentIdx").text();
        var spanTag = $(this).next();

        $.ajax({
          url: "/ulComment/like/" + ulCommentIdx,  // URL에 ulCommentIdx 값 포함
          method: "POST",
          success: function (data) {
            console.log(data);
            spanTag.text(data);
            // $("#likeUlComment").text(data);  // 추천수 업데이트
            alert("댓글 추천 완료!");
          },
          error: function (xhr, status, error) {
            console.error("Error: " + error);
          }
        });
      });
    }
  </script>
</head>
<body>

<main class="" th:fragment="comment(comments)">
  <section>
    <div method="GET" id="ulcomfrm">
      <div class="d-none" id="ulcomment_method" name="ulcommentMethod"></div>
      <div>
        <button id="ulCommentIdxAsc" class="btn btn-light text-muted">등록순</button>
        <button id="ulCommentIdxDesc" class="btn btn-light text-muted">최신순</button>
      </div>
      <!--        댓글 목록-->
      <div id="commentsList" class="mt-2">
        <div th:each="comment : ${ulcomment}">
          <div class="d-flex mb-3">
            <div class="col-sm-1">
              <img src="/img/프로필.jpg" style="width: 40px; height: 40px" alt="프로필">
            </div>
            <div class="ml-1 flex-grow-1">
              <div class="comment">
                <p class="d-none commentIdx" name="commentIdx"
                   th:text="${comment.ulCommentIdx}"></p>
                <p>
                  <strong th:text="${comment.ulCommentNickname}"></strong>
                </p>
                <p>
                  <span th:text="${comment.ulCommentLocation}"></span>
                  <span th:text="${comment.ulCommentcreatedate}"></span>
                </p>
                <p><strong th:text="${comment.ulCommentContents}"></strong></p>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <img src="/img/good.png" style="width:22px; height: 22px;" alt="댓글추천"
                         th:alt="${comment.ulCommentIdx}" class="ulCommentLike">
                    <span th:text="${comment.ulCommentLike}">0</span>
                  </div>
                  <div class="ml-3">
                    <button type="button" class="btn btn-outline-dark text-dark"
                            id="ulcommentDelete">삭제
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!--        댓글 작성-->
      <!--            board_idx, nickname, comment_content, create_date, location-->
      <div class="mt-3">
        <form method="post" th:action="@{|/board/${ul.ulIdx}/add|}">
          <div>
                        <textarea class="form-control" name="ulCommentContents" id="ulCommentContents" rows="3"
                                  placeholder="댓글을 입력하세요."></textarea>
          </div>
          <button type="submit" class="btn btn-primary mt-2" id="com_add">댓글 작성</button>
        </form>
      </div>
    </div>
  </section>


</main>
</body>
</html>